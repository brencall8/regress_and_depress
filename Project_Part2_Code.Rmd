---
title: "Appendix B"
author: "Brendan Callender, Martin Hsu, and Rachel Roggenkemper"
date: "5/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Appendix 3A: Loading R Packages Used in Analysis
```{r}
library(tidyverse)
library(readxl)
library(leaps)
library(car)
library(scatterplot3d)
library(GGally)
library('lmtest')
```

## Appendix 3B: R Code Data Importing and Cleaning 
```{r}
realestate <- read_excel("SLO_Real_Estate_Feb-Apr2022.xlsx")

realestate_clean <- realestate %>%
  filter(LotSize != 416869 & LotSize != 108900 & LotSize != 84071)

realestate_clean <- realestate_clean %>%
  mutate(HomeTypeNew = 
           case_when(HomeType == "Condominium" ~ "Condo", 
             HomeType == "SingleFamilyResidence" ~ "SingleFam",
             HomeType == "ManufacturedHome" ~ "Manufactured",
             TRUE ~ "Other")) 

realestate_clean$Cooling = factor(realestate_clean$Cooling)
realestate_clean$Heating = factor(realestate_clean$Heating)
realestate_clean$HomeType = factor(realestate_clean$HomeType)
realestate_clean$HomeTypeNew = factor(realestate_clean$HomeTypeNew)
realestate_clean$Pool = factor(realestate_clean$Pool)
```



# IV. Split the Data
## Appendix 4A: R Code for Data Splitting
```{r}
n <- 141
numtrain = ceiling(.8*n)
set.seed(678)
train_ind = sample(n, numtrain)
traindata = realestate_clean[train_ind, ]
testdata = realestate_clean[-train_ind, ]
set.seed(NULL)
```



# V. Data Visualization
## Appendix 5A: R Code for Generating Figure 5.1
```{r}
# Figure 5.1: Matrix Scatterplot (outliers not removed)
pairs(SoldPrice ~ Sqft + Bed + Bath + YearBuilt + LotSize + Parking, data = realestate, 
      col = c('cornflowerblue','royalblue','cyan', 'darkseagreen')[factor(realestate_clean$HomeTypeNew)], 
      pch = 19)
```

## Appendix 5B: R Code for Generating Table 5.1
```{r}
# Table 5.1: Correlation Matrix (outliers not removed)
cor(realestate[,c(1, 2, 3, 4, 5, 6, 7)])
```

## Appendix 5C: R Code for Generating Figure 5.2
```{r}
# Figure 5.2: Matrix Scatterplot with ggpairs()
ggpairs(traindata[,-c(8:12)], 
        upper=list(continuous='points'),
        lower=list(continuous='cor',combo='blank',discrete='blank'))  +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Appendix 5D: R Code for Generating Figure 5.3
```{r}
# Figure 5.3: Interaction Plot Between Sold Price and Square Footage (Home Type)
fit_interaction = lm(SoldPrice~Sqft*HomeTypeNew, data=traindata)
summary(fit_interaction)

plot(SoldPrice ~ Sqft, data = traindata, 
     col = c('cornflowerblue','royalblue','cyan', 'darkseagreen')[HomeTypeNew], 
     pch = c(15, 16, 17, 18)[HomeTypeNew])
legend('bottomright',legend=levels(traindata$HomeTypeNew),
       pch = c(15, 16, 17, 18),
       col = c('cornflowerblue','royalblue','cyan', 'darkseagreen'),
       lty = 1)
abline(coeff[1], coeff[2], col='cornflowerblue')
abline(coeff[1] + coeff[3], coeff[2] + coeff[6], col = 'royalblue') 
abline(coeff[1] + coeff[4], coeff[2] + coeff[7], col = 'cyan') 
abline(coeff[1] + coeff[5], coeff[2] + coeff[8], col = 'seagreen') 
```

## Appendix 5E: R Code for Generating Figure 5.4
```{r}
# Figure 5.4: Interaction Plot Between Home Type and Pool
with(traindata, interaction.plot(HomeTypeNew, Pool, SoldPrice, type = 'b', 
                                 col = c('royalblue','cyan'), 
                                 pch = c(16, 17)))
with(traindata, interaction.plot(Pool, HomeTypeNew, SoldPrice, type = 'b', 
                                 col = c('cornflowerblue','royalblue','cyan', 'darkseagreen'), 
                                 pch = c(16, 17)))
```

## Appendix 5F: R Code for Generating Figure 5.5
## Appendix 5G: R Code for Generating Figure 5.6
## Appendix 5H: R Code for Generating Figure 5.7
## Appendix 5I: R Code for Generating Figure 5.8
```{r}
# Histograms of Quantitative Variables 
# Figure 5.5: Distribution of Sqft
traindata %>%
  ggplot(aes(x = Sqft)) +
  geom_histogram(bins = 10) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

# Figure 5.6: Distribution of Sqft, by HomeTypeNew
traindata %>%
  ggplot(aes(x = Sqft, fill = HomeTypeNew)) +
  geom_histogram(bins = 10) +
  scale_fill_manual(values = c('aquamarine', 'cornflowerblue','royalblue', 'cadetblue', 'cyan', 
                               'darkblue', 'deepskyblue', 'darkseagreen', 'darkseagreen1')) +
  facet_wrap(~HomeTypeNew) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

# Figure 5.7: Distribution of LotSize
traindata %>%
  ggplot(aes(x = LotSize)) +
  geom_histogram(binwidth = 2000) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

# Figure 5.8: Distribution of Lotsize, by HomeTypeNew
traindata %>%
  ggplot(aes(x = LotSize, fill = HomeTypeNew)) +
  geom_histogram(binwidth = 2000) +
  scale_fill_manual(values = c('aquamarine', 'cornflowerblue','royalblue', 'cadetblue', 'cyan', 
                               'darkblue', 'deepskyblue', 'darkseagreen', 'darkseagreen1')) +
  facet_wrap(~HomeTypeNew) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Appendix 5J: R Code for Generating Figure 5.9
```{r}
# Figure 5.9: Distribution of Sqft and LotSize as predictors of SoldPrice
# 3D Scatterplot 
s3d <- scatterplot3d(traindata2$Sqft, y=traindata2$SoldPrice, z=traindata2$LotSize,
                     xlab = "Square Footage (sqft)",
                     ylab = "Sold Price (Dollars)",
                     zlab = "Lot Size (sqft)", 
                     angle=55, pch = 16)
# Add regression plane
my.lm <- lm(traindata2$Sqft ~ traindata2$SoldPrice + traindata2$LotSize)
s3d$plane3d(my.lm)
```


# Part VI. Variable Pre-Processing
Using Best Subsets, a model containing Sqft, YearBuilt, and HomeTypeNew looked like the best option for the project.
```{r}
traindataNew <- traindata %>%
  select(-HomeType)

full.model <- lm(SoldPrice~., data = traindataNew)

best.sub <- summary(regsubsets(formula(full.model), data=traindata, method = "exhaustive", nbest = 2))
```

```{r}
n = nrow(traindata)
p<-c(2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9) 

SSE<-best.sub$rss             #SSE 
s<-sqrt(SSE/(n-p))            #s
Rsq<-best.sub$rsq             #R-squared 
Rsq.adj<-best.sub$adjr2       #R-squared adjusted
BIC<-n*log(SSE/n) + p*log(n)  #BIC
AIC<- n*log(SSE/n) + 2*p      #AIC
Cp<-best.sub$cp               #Mallow's Cp
bs<- data.frame(best.sub$outmat, p=p, Cp, AIC, BIC, Rsq, Rsq.adj, s) %>%
  arrange(BIC)
```

Many models reccomended the inclusion of lot size however one AVPlot ruled out LotSize immediately.  You can see one point that is heavily influencing the entire trend.  This is very simular to one plot from Anscomb's Quartet. So the next best Model that met the project requirements 

```{r}
plot(resid(lm(I(sqrt(SoldPrice))~Sqft + HomeTypeNew, data = traindata))~resid(lm(LotSize ~ YearBuilt + Sqft + HomeTypeNew, data = traindata)))
```

```{r}
fit.one <- lm(SoldPrice ~ Sqft + LotSize + HomeTypeNew, data  = traindata)

plot(fit.one)
```

Looking at residual vs predicted plot, there is a obvious violation of the equal variance assumption as well as normality assumption.  We will likely need a transform the response and then transform a predictor if necessary.

Since we are transforming the y variable we can use the BoxCox procedure to see which transformation of the response minimizes the SSE.

```{r}
boxCox(lm(SoldPrice~Sqft+LotSize+HomeTypeNew, data = traindata))
```

Using Box-Cox, we decided a sqrt (1/2) transformation on the response variable of SoldPrice because it is contained in the confidence interval for the box cox transformation.

```{r}
fit.two <- lm(I(sqrt(SoldPrice)) ~ Sqft + LotSize + HomeTypeNew, data  = traindata)

plot(fit.two)
```

```{r}
full.model2 <- lm(I(sqrt(SoldPrice))~., data = traindataNew)

best.sub2 <- summary(regsubsets(formula(full.model2), data=traindata, method = "exhaustive", nbest = 2))
```

```{r}
n = nrow(traindata)
p<-c(2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9) 

SSE<-best.sub2$rss             #SSE 
s<-sqrt(SSE/(n-p))             #s
Rsq<-best.sub2$rsq             #R-squared 
Rsq.adj<-best.sub2$adjr2       #R-squared adjusted
BIC<-n*log(SSE/n) + p*log(n)   #BIC
AIC<- n*log(SSE/n) + 2*p       #AIC
Cp<-best.sub2$cp               #Mallow's Cp
bs2<- data.frame(best.sub2$outmat, p=p, Cp, AIC, BIC, Rsq, Rsq.adj, s) %>%
  arrange(BIC)
```


# VII. Residual Analysis
## Appendix 7A: R Code for Generating Figure 7.1
## Appendix 7B: R Code for Generating Figure 7.2
## Appendix 7C: R Code for Generating Figure 7.3
## Appendix 7D: R Code and Output for Breusch-Pagan Test on Model Residuals
## Appendix 7E: R Code and Output for Shapiro-Wilk Test on Model Residuals
```{r}
final_model = lm(I(sqrt(SoldPrice)) ~ Sqft + LotSize + HomeTypeNew, data = traindata)

# Figure 7.1: Four-in-One Model Diagnostic Plot 
par(mfrow=c(2,2)) #plot in 2 by 2 grid   
plot(final_model)

# Figure 7.2: Residuals Plotted against Fitted Values, Sqft, LotSize, and HomeTypeNew
par(mfrow=c(2,2)) #plot in 2 by 2 grid  

plot(resid(final_model) ~ fitted(final_model), ylab='Residuals', xlab='Fitted')
abline(h=0,lty=2)

plot(resid(final_model) ~ Sqft, data=traindata, ylab='Residuals', xlab='Sqft')
abline(h=0,lty=2) 

plot(resid(final_model) ~ LotSize, data=traindata, ylab='Residuals', xlab='Lot Size')
abline(h=0,lty=2) 

plot(resid(final_model) ~ HomeTypeNew, data=traindata, ylab='Residuals', xlab='HomeTypeNew')
abline(h=0,lty=2)

par(mfrow=c(1,1))

# Figure 7.3: Distribution of Model Residuals 
hist(resid(final_model), main='', xlab='Residuals')

shapiro.test(resid(final_model))
bptest(final_model)
```



# VIII. Fit a Linear Model 
```{r}
summary(fit.two)
```


```{r}
vif(fit.two)
```



# IX. Statistical Inference
## Appendix 9A: R Code and Output for Overall F-Test
```{r}
# Figure 9.1: Overall F-Test
summary(final_model)
```

## Appendix 9B: R Code and Output for Partial F-Test
```{r}
# Figure 9.2: Partial F-Test
model_reduced = lm(I(sqrt(SoldPrice)) ~ Sqft, data=traindata)
anova(model_reduced, final_model)
```

## Appendix 9C: R Code and Output for Partial F-Test for Interaction 
## Appendix 9D: R Code and Output for Partial F-Test for Interaction 
```{r}
# Figure 9.3: Test for Sqft:HomeTypeNew Interaction Significance
anova(lm(I(sqrt(SoldPrice)) ~ LotSize + Sqft + HomeTypeNew, data = traindata), 
      lm(I(sqrt(SoldPrice)) ~ LotSize + Sqft + HomeTypeNew + Sqft:HomeTypeNew, data = traindata))

# Figure 9.4: Test for Sqft:LotSize Interaction Significance
anova(lm(I(sqrt(SoldPrice)) ~ LotSize + Sqft + HomeTypeNew, data = traindata), 
      lm(I(sqrt(SoldPrice)) ~ LotSize + Sqft + HomeTypeNew + Sqft:LotSize, data = traindata))
```

## Appendix 9E: R Code and Output for Confidence Intervals 
```{r}
# Figure 9.5: CIs for Mean Response Value and Future Predicted Value 
traindata_singlefam <- traindata %>%
  filter(HomeTypeNew == "SingleFam")

mean(traindata_singlefam$Sqft)
mean(traindata_singlefam$LotSize)

new.house = data.frame(Sqft = 1865, LotSize = 7079, HomeTypeNew = "SingleFam")

predict(final_model, newdata = new.house, interval = "confidence", level=0.95)
predict(final_model, newdata = new.house, interval = "prediction", level=0.95)
```


